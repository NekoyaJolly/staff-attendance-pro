<source>
  @type tail
  path /var/log/backup/*.log
  pos_file /var/log/fluentd/backup.log.pos
  tag backup.system
  <parse>
    @type regexp
    expression /^\[(?<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\] (?<level>\w+): (?<message>.*)$/
  </parse>
</source>

<source>
  @type tail
  path /var/log/nginx/access.log
  pos_file /var/log/fluentd/nginx.access.log.pos
  tag nginx.access
  <parse>
    @type nginx
  </parse>
</source>

<source>
  @type tail
  path /var/log/nginx/error.log
  pos_file /var/log/fluentd/nginx.error.log.pos
  tag nginx.error
  <parse>
    @type regexp
    expression /^(?<timestamp>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[(?<level>\w+)\] (?<message>.*)$/
  </parse>
</source>

<filter backup.system>
  @type record_transformer
  <record>
    service "backup-system"
    environment "production"
  </record>
</filter>

<match backup.system>
  @type file
  path /var/log/aggregated/backup
  <format>
    @type json
  </format>
  <buffer>
    @type file
    path /var/log/fluentd/backup.buffer
    flush_interval 60s
  </buffer>
</match>

<match nginx.**>
  @type file
  path /var/log/aggregated/nginx
  <format>
    @type json
  </format>
  <buffer>
    @type file
    path /var/log/fluentd/nginx.buffer
    flush_interval 60s
  </buffer>
</match>