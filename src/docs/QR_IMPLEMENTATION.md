# QRコード機能実装ドキュメント

## 概要
勤怠管理システムにQRコードスキャン機能とカメラAPIとの連携機能を実装しました。本機能により、スタッフは専用QRコードをスキャンして勤怠記録を行うことができます。

## 実装した機能

### 1. QRコードスキャン機能
- **ファイル**: `src/components/timecard/QRScanner.tsx`
- **機能**:
  - カメラAPIとの連携
  - リアルタイムQRコードスキャン
  - フロント/バックカメラの切り替え
  - スキャン結果の検証
  - セキュリティチェック

### 2. QRコード生成機能
- **ファイル**: `src/components/timecard/QRGenerator.tsx`
- **機能**:
  - 勤怠管理用QRコードの生成
  - 場所情報を含むQRコード作成
  - QRコード画像のダウンロード
  - 複数場所に対応

### 3. セキュリティ機能
- **ファイル**: `src/lib/qrCodeSecurity.ts`
- **機能**:
  - QRコードデータの検証
  - スキャン頻度制限
  - 不正アクセス検出
  - エラーレポート機能

### 4. 統合テスト機能
- **ファイル**: `src/lib/integrationTests.ts`, `src/lib/systemIntegration.ts`
- **機能**:
  - カメラAPI動作テスト
  - QRコード生成・検証テスト
  - フロントエンド統合テスト
  - パフォーマンステスト

### 5. テストインターフェース
- **ファイル**: `src/components/timecard/QRTest.tsx`
- **機能**:
  - 統合テスト実行UI
  - 個別機能テスト
  - テスト結果の可視化

## 技術仕様

### 使用ライブラリ
- `qr-scanner`: QRコードスキャン機能
- `qrcode`: QRコード生成機能
- カメラAPI: MediaDevices.getUserMedia()

### QRコードデータ構造
```json
{
  "type": "attendance-qr",
  "locationId": "main",
  "locationName": "メインエントランス",
  "timestamp": 1703123456789,
  "version": "1.0"
}
```

### セキュリティ機能
1. **データ検証**:
   - 必須フィールドの確認
   - タイムスタンプの有効性チェック
   - 場所IDの許可リスト照合

2. **アクセス制御**:
   - スキャン頻度制限（1分間に5回まで）
   - 営業時間外アクセス検出
   - 短時間での連続アクセス検出

3. **エラーハンドリング**:
   - 詳細なエラーログ
   - セキュリティアラート
   - 自動復旧機能

## API設計

### QRScanner Props
```typescript
interface QRScannerProps {
  isOpen: boolean
  onClose: () => void
  onScanSuccess: (data: string) => void
  staffId?: string
}
```

### QRGenerator Props
```typescript
interface QRGeneratorProps {
  locationId?: string
  locationName?: string
}
```

## 動作フロー

### 1. QRコードスキャンフロー
1. スタッフが勤怠記録ボタンをタップ
2. カメラ権限の確認・取得
3. QRスキャナーの起動
4. QRコード検出・解析
5. セキュリティ検証
6. 勤怠データの保存
7. 完了通知

### 2. エラーハンドリングフロー
1. エラー発生時の検出
2. エラーカテゴリの分類
3. ユーザーへの適切な通知
4. ログ記録・レポート
5. 必要に応じた自動復旧

## テスト項目

### 単体テスト
- [x] カメラAPI接続テスト
- [x] QRコード生成テスト
- [x] データ検証テスト
- [x] セキュリティ機能テスト

### 統合テスト
- [x] QRスキャン→勤怠記録フロー
- [x] エラーハンドリング
- [x] ユーザーインターフェース
- [x] パフォーマンス

### セキュリティテスト
- [x] 不正QRコード検出
- [x] アクセス頻度制限
- [x] 営業時間外アクセス検出
- [x] データ整合性チェック

## 使用方法

### 管理者側
1. 管理者ダッシュボードの「QRコード」タブにアクセス
2. 各場所用のQRコードを生成
3. QRコード画像をダウンロード
4. 各場所に印刷して設置

### スタッフ側
1. タイムカードページで出勤/退勤ボタンをタップ
2. 「QRコード」ボタンを選択
3. カメラでQRコードをスキャン
4. 勤怠記録の完了確認

## パフォーマンス指標

### 推奨動作環境
- カメラ解像度: 1280x720以上
- スキャン距離: 10-30cm
- 明度: 十分な照明環境

### パフォーマンス目標
- スキャン時間: 3秒以内
- カメラ起動時間: 2秒以内
- メモリ使用量: 80%以下
- バッテリー消費: 最小化

## トラブルシューティング

### よくある問題
1. **カメラが起動しない**
   - ブラウザのカメラ権限を確認
   - HTTPSでのアクセスが必要

2. **QRコードが読み取れない**
   - 十分な明度を確保
   - QRコードとの距離を調整
   - カメラレンズの清掃

3. **セキュリティエラー**
   - 有効なQRコードかを確認
   - スキャン頻度を調整

## 今後の拡張予定

### 機能拡張
- [ ] 複数QRコード同時読取
- [ ] オフライン対応
- [ ] バルクスキャン機能
- [ ] 音声ガイダンス

### セキュリティ強化
- [ ] QRコード暗号化
- [ ] デバイス認証
- [ ] 位置情報連携
- [ ] 生体認証統合

## 開発者向け情報

### デバッグ機能
- コンソールログの詳細出力
- テストモードでの模擬QRコード
- エラーレポート機能
- パフォーマンス監視

### 設定可能項目
```typescript
// セキュリティ設定
const config = {
  maxScanRetries: 3,
  timeoutMs: 30000,
  allowedLocationIds: ['main', 'staff-room', 'office'],
  validationEnabled: true
}
```

## 更新履歴

### v1.0.0 (初回実装)
- QRコードスキャン基本機能
- QRコード生成機能
- セキュリティ機能
- 統合テスト機能
- 管理者向けテストインターフェース

---

本ドキュメントは実装完了時点での機能仕様を記載しています。機能追加や変更があった場合は適宜更新してください。